<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FTB Nano Banana Maker</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #fde047, #f97316);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #737373;
      margin-bottom: 2rem;
    }

    /* API Key Section */
    .api-section {
      background: #171717;
      border: 1px solid #262626;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .api-section.connected {
      border-color: #22c55e;
    }

    .api-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .api-header h2 {
      font-size: 0.875rem;
      color: #a3a3a3;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .api-status {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      background: #262626;
      color: #737373;
    }

    .api-status.active {
      background: #14532d;
      color: #4ade80;
    }

    .api-input-group {
      display: flex;
      gap: 0.5rem;
    }

    .api-input-group input {
      flex: 1;
      padding: 0.75rem 1rem;
      background: #0a0a0a;
      border: 1px solid #404040;
      border-radius: 8px;
      color: #e5e5e5;
      font-size: 0.875rem;
    }

    .api-input-group input:focus {
      outline: none;
      border-color: #fde047;
    }

    .btn {
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #fde047, #f97316);
      color: #0a0a0a;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-danger {
      background: #7f1d1d;
      color: #fca5a5;
    }

    .btn-danger:hover {
      background: #991b1b;
    }

    .btn-secondary {
      background: #262626;
      color: #e5e5e5;
      border: 1px solid #404040;
    }

    .btn-secondary:hover {
      background: #333;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 0;
    }

    .tab {
      flex: 1;
      padding: 1rem 1.5rem;
      background: #0a0a0a;
      border: 1px solid #262626;
      border-bottom: none;
      color: #737373;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }

    .tab:first-child {
      border-radius: 12px 0 0 0;
    }

    .tab:last-child {
      border-radius: 0 12px 0 0;
    }

    .tab:hover {
      color: #a3a3a3;
    }

    .tab.active {
      background: #171717;
      color: #fde047;
      border-color: #262626;
    }

    .tab-icon {
      margin-right: 0.5rem;
    }

    /* Main Section */
    .main-section {
      background: #171717;
      border: 1px solid #262626;
      border-top: none;
      border-radius: 0 0 12px 12px;
      padding: 1.5rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Create Section */
    .idea-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .idea-row input {
      flex: 1;
      padding: 0.75rem 1rem;
      background: #0a0a0a;
      border: 1px solid #404040;
      border-radius: 8px;
      color: #e5e5e5;
      font-size: 0.875rem;
    }

    .idea-row input:focus {
      outline: none;
      border-color: #4ade80;
    }

    .idea-row input::placeholder {
      color: #525252;
    }

    .create-btn {
      background: #14532d;
      color: #4ade80;
      border: 1px solid #166534;
    }

    .create-btn:hover {
      background: #166534;
    }

    .prompt-area {
      margin-bottom: 1.5rem;
    }

    .prompt-area label {
      display: block;
      font-size: 0.875rem;
      color: #a3a3a3;
      margin-bottom: 0.5rem;
    }

    .prompt-area textarea {
      width: 100%;
      min-height: 100px;
      padding: 1rem;
      background: #0a0a0a;
      border: 1px solid #404040;
      border-radius: 8px;
      color: #e5e5e5;
      font-size: 1rem;
      font-family: inherit;
      resize: vertical;
    }

    .prompt-area textarea:focus {
      outline: none;
      border-color: #fde047;
    }

    .prompt-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .enhance-btn {
      background: #1e1b4b;
      color: #a5b4fc;
      border: 1px solid #3730a3;
    }

    .enhance-btn:hover {
      background: #312e81;
    }

    /* Edit Section */
    .upload-area {
      border: 2px dashed #404040;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
      background: #0a0a0a;
      margin-bottom: 1rem;
    }

    .upload-area:hover {
      border-color: #fde047;
      background: #0f0f0a;
    }

    .upload-area.has-image {
      padding: 0.75rem;
      border-style: solid;
      border-color: #22c55e;
    }

    .upload-area input[type="file"] {
      display: none;
    }

    .upload-placeholder {
      color: #737373;
    }

    .upload-placeholder span {
      display: block;
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .upload-placeholder small {
      display: block;
      color: #525252;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }

    .images-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .image-item {
      position: relative;
      border: 2px solid #22c55e;
      border-radius: 8px;
      overflow: hidden;
      background: #0a0a0a;
    }

    .image-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      display: block;
    }

    .image-item .image-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.85);
      color: #4ade80;
      font-size: 0.6rem;
      padding: 0.2rem;
      text-align: center;
      font-weight: 600;
    }

    .remove-image {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-image:hover {
      background: #b91c1c;
    }

    .add-more-btn {
      width: 100px;
      height: 100px;
      border: 2px dashed #404040;
      border-radius: 8px;
      background: #0a0a0a;
      color: #737373;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      transition: all 0.15s;
    }

    .add-more-btn:hover {
      border-color: #fde047;
      color: #e5e5e5;
    }

    .add-more-btn span {
      font-size: 1.25rem;
    }

    .add-more-btn small {
      font-size: 0.6rem;
    }

    /* Quick Presets */
    .presets-section {
      margin-bottom: 1.5rem;
    }

    .presets-label {
      font-size: 0.75rem;
      color: #525252;
      margin-bottom: 0.5rem;
      display: block;
    }

    .presets-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .preset-btn {
      padding: 0.4rem 0.6rem;
      font-size: 0.7rem;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #a3a3a3;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .preset-btn:hover {
      background: #262626;
      border-color: #fde047;
      color: #e5e5e5;
    }

    /* Model Selection */
    .model-selection {
      margin-bottom: 1.5rem;
    }

    .model-selection label {
      display: block;
      font-size: 0.875rem;
      color: #a3a3a3;
      margin-bottom: 0.75rem;
    }

    .model-options {
      display: flex;
      gap: 0.75rem;
    }

    .model-option {
      flex: 1;
      padding: 0.75rem;
      background: #0a0a0a;
      border: 2px solid #404040;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .model-option:hover {
      border-color: #525252;
    }

    .model-option.selected {
      border-color: #fde047;
      background: #1a1a0a;
    }

    .model-option input {
      display: none;
    }

    .model-name {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.15rem;
    }

    .model-desc {
      font-size: 0.7rem;
      color: #737373;
    }

    /* Generate Button */
    .generate-section {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .btn-generate {
      padding: 1rem 2rem;
      font-size: 1rem;
    }

    /* Output Section */
    .output-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #262626;
    }

    .output-section h3 {
      font-size: 0.875rem;
      color: #a3a3a3;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .output-content {
      background: #0a0a0a;
      border: 1px solid #404040;
      border-radius: 8px;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .output-content img {
      max-width: 100%;
      max-height: 600px;
      object-fit: contain;
    }

    .output-placeholder {
      color: #525252;
      text-align: center;
      padding: 2rem;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      color: #737373;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #262626;
      border-top-color: #fde047;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #450a0a;
      border: 1px solid #7f1d1d;
      color: #fca5a5;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .text-response {
      padding: 1rem;
      color: #a3a3a3;
      font-size: 0.875rem;
      white-space: pre-wrap;
    }

    .format-hint {
      font-size: 0.7rem;
      color: #525252;
      margin-top: 0.5rem;
    }

    .output-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .btn-download {
      background: #14532d;
      color: #4ade80;
      border: 1px solid #166534;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-download:hover {
      background: #166534;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .model-options {
        flex-direction: column;
      }
      .api-input-group {
        flex-direction: column;
      }
      .idea-row {
        flex-direction: column;
      }
      .idea-row input {
        width: 100%;
      }
      .tab {
        padding: 0.75rem;
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>FTB Nano Banana Maker üçå</h1>
    <p class="subtitle">Image generation powered by Gemini</p>

    <!-- API Key Section -->
    <div class="api-section" id="apiSection">
      <div class="api-header">
        <h2>API Key</h2>
        <span class="api-status" id="apiStatus">Not connected</span>
      </div>
      <form class="api-input-group" id="apiInputGroup" onsubmit="return false;">
        <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API key" autocomplete="current-password">
        <button class="btn btn-primary" id="saveApiBtn" type="button">Save</button>
      </form>
      <div class="api-input-group" id="apiConnectedGroup" style="display: none;">
        <input type="text" value="API key saved" disabled>
        <button class="btn btn-danger" id="deleteApiBtn">Delete</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="create">
        <span class="tab-icon">‚ú®</span>Create
      </button>
      <button class="tab" data-tab="edit">
        <span class="tab-icon">üñºÔ∏è</span>Edit
      </button>
    </div>

    <!-- Main Section -->
    <div class="main-section">
      <!-- Create Tab -->
      <div class="tab-content active" id="createTab">
        <div class="idea-row">
          <input type="text" id="ideaInput" placeholder="Quick idea: cat in space, retro diner, mountain sunset...">
          <button class="btn create-btn" id="createBtn">Create Prompt</button>
        </div>

        <div class="prompt-area">
          <label for="createPromptInput">Describe the image you want to generate</label>
          <textarea id="createPromptInput" placeholder="A cinematic wide shot of a Golden Retriever sprinting through a sunlit park at golden hour. The low sun casts long shadows on the grass."></textarea>
          <div class="prompt-actions">
            <button class="btn enhance-btn" id="createEnhanceBtn">Enhance Prompt</button>
            <button class="btn btn-secondary" id="createClearBtn">Clear</button>
          </div>
        </div>

        <div class="model-selection">
          <label>Model</label>
          <div class="model-options">
            <label class="model-option selected">
              <input type="radio" name="createModel" value="gemini-2.5-flash-image" checked>
              <div class="model-name">Flash Image</div>
              <div class="model-desc">Fast, cost-effective</div>
            </label>
            <label class="model-option">
              <input type="radio" name="createModel" value="gemini-3-pro-image-preview">
              <div class="model-name">Pro Image</div>
              <div class="model-desc">Advanced, up to 4K</div>
            </label>
          </div>
        </div>

        <div class="generate-section">
          <button class="btn btn-primary btn-generate" id="createGenerateBtn" disabled>Generate Image</button>
        </div>
      </div>

      <!-- Edit Tab -->
      <div class="tab-content" id="editTab">
        <div class="upload-area" id="uploadArea">
          <input type="file" id="imageInput" accept=".png,.jpg,.jpeg,.gif,.webp,image/png,image/jpeg,image/gif,image/webp" multiple>
          <div class="upload-placeholder" id="uploadPlaceholder">
            <span>üìÅ</span>
            <p>Click or drag images here</p>
            <small>PNG, JPG, GIF, WEBP ‚Ä¢ Max 20MB each ‚Ä¢ Up to 14 images</small>
          </div>
          <div class="images-grid" id="imagesGrid" style="display: none;"></div>
        </div>

        <div class="presets-section" id="presetsSection" style="display: none;">
          <span class="presets-label">Quick presets (or write your own below)</span>
          <div class="presets-grid" id="singlePresets">
            <button class="preset-btn" data-prompt="Remove the background and make it transparent">Remove background</button>
            <button class="preset-btn" data-prompt="Apply a vintage film look with warm tones and subtle grain">Vintage</button>
            <button class="preset-btn" data-prompt="Convert to a pencil sketch style drawing">Pencil sketch</button>
            <button class="preset-btn" data-prompt="Make this image look like a watercolor painting">Watercolor</button>
            <button class="preset-btn" data-prompt="Add dramatic cinematic lighting">Cinematic</button>
            <button class="preset-btn" data-prompt="Transform into pixel art style">Pixel art</button>
            <button class="preset-btn" data-prompt="Enhance colors and make them more vibrant">Enhance colors</button>
          </div>
          <div class="presets-grid" id="multiPresets" style="display: none;">
            <button class="preset-btn" data-prompt="Combine these images into a single cohesive composition">Combine</button>
            <button class="preset-btn" data-prompt="Create a YouTube thumbnail using Image 1 as background and Image 2 as the person/subject">Thumbnail</button>
            <button class="preset-btn" data-prompt="Place the person from Image 2 into the scene from Image 1, matching lighting">Composite</button>
            <button class="preset-btn" data-prompt="Apply the artistic style from Image 1 to Image 2">Style transfer</button>
            <button class="preset-btn" data-prompt="Create a before/after comparison side by side">Before/After</button>
            <button class="preset-btn" data-prompt="Blend these images together seamlessly">Blend</button>
            <button class="preset-btn" data-prompt="Use Image 1 as template, swap in face from Image 2">Face swap</button>
            <button class="preset-btn" data-prompt="Create a collage combining all images">Collage</button>
          </div>
        </div>

        <div class="prompt-area">
          <label for="editPromptInput">What do you want to do with the image(s)?</label>
          <textarea id="editPromptInput" placeholder="Describe the edit in natural language, e.g.: 'Add a rainbow in the background' or 'Make it look like a oil painting' or 'Put the person from image 2 into the scene from image 1'"></textarea>
          <div class="prompt-actions">
            <button class="btn btn-secondary" id="editClearBtn">Clear All</button>
          </div>
        </div>

        <div class="model-selection">
          <label>Model</label>
          <div class="model-options">
            <label class="model-option selected">
              <input type="radio" name="editModel" value="gemini-2.5-flash-image" checked>
              <div class="model-name">Flash Image</div>
              <div class="model-desc">Fast, cost-effective</div>
            </label>
            <label class="model-option">
              <input type="radio" name="editModel" value="gemini-3-pro-image-preview">
              <div class="model-name">Pro Image</div>
              <div class="model-desc">Advanced, up to 4K</div>
            </label>
          </div>
        </div>

        <div class="generate-section">
          <button class="btn btn-primary btn-generate" id="editGenerateBtn" disabled>Apply Edit</button>
        </div>
      </div>

      <!-- Shared Output Section -->
      <div class="output-section" id="outputSection" style="display: none;">
        <h3>Result</h3>
        <div class="output-content" id="outputContent">
          <div class="output-placeholder">Your image will appear here</div>
        </div>
        <div class="output-actions" id="outputActions" style="display: none;">
          <button class="btn btn-download" id="downloadBtn">‚¨á Download Image</button>
        </div>
      </div>

      <div class="error-message" id="errorMessage" style="display: none;"></div>
    </div>
  </div>

  <script>
    // System prompts
    const PROMPT_ENHANCEMENT_SYSTEM = `You are a prompt enhancement specialist for Nano Banana Pro (Gemini 3 Pro Image), Google's advanced image generation model.

Your job is to take a user's basic prompt and enhance it following these best practices:

## Core Philosophy
Talk to it like a Creative Director, not a search engine. Use natural language.

## Structure to add:
1. Subject (Who/What) - be specific
2. Action (Doing what)
3. Environment (Where)
4. Lighting/Mood (Time of day, atmosphere)
5. Technical Specs (Camera angle, style, texture)

## Rules:
- NEVER use tag soup like "dog, park, 4k, realistic"
- DO write natural, flowing sentences
- Include lighting, mood, and technical details
- Keep it concise but descriptive

Return ONLY the enhanced prompt, no explanation.`;

    const PROMPT_CREATION_SYSTEM = `You are a prompt creation specialist for Nano Banana Pro (Gemini 3 Pro Image).

Your job is to take a user's basic idea (just a few words) and create a complete, detailed prompt.

## Structure:
1. Subject - be specific and detailed
2. Action - add interesting action or pose
3. Environment - create an interesting setting
4. Lighting/Mood - be cinematic
5. Technical - add film/photo qualities

## Rules:
- NEVER use tag soup
- DO write natural, flowing sentences
- Be creative and specific
- Keep it to 2-3 sentences

Return ONLY the prompt, no explanation.`;

    // DOM Elements
    const apiSection = document.getElementById('apiSection');
    const apiStatus = document.getElementById('apiStatus');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const saveApiBtn = document.getElementById('saveApiBtn');
    const deleteApiBtn = document.getElementById('deleteApiBtn');
    const apiInputGroup = document.getElementById('apiInputGroup');
    const apiConnectedGroup = document.getElementById('apiConnectedGroup');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const outputSection = document.getElementById('outputSection');
    const outputContent = document.getElementById('outputContent');
    const outputActions = document.getElementById('outputActions');
    const downloadBtn = document.getElementById('downloadBtn');
    const errorMessage = document.getElementById('errorMessage');

    // Store generated image for download
    let generatedImageData = null;
    let generatedImageMimeType = null;

    // Create tab elements
    const ideaInput = document.getElementById('ideaInput');
    const createBtn = document.getElementById('createBtn');
    const createPromptInput = document.getElementById('createPromptInput');
    const createEnhanceBtn = document.getElementById('createEnhanceBtn');
    const createClearBtn = document.getElementById('createClearBtn');
    const createGenerateBtn = document.getElementById('createGenerateBtn');
    const createModelOptions = document.querySelectorAll('#createTab .model-option');

    // Edit tab elements
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const imagesGrid = document.getElementById('imagesGrid');
    const presetsSection = document.getElementById('presetsSection');
    const singlePresets = document.getElementById('singlePresets');
    const multiPresets = document.getElementById('multiPresets');
    const editPromptInput = document.getElementById('editPromptInput');
    const editClearBtn = document.getElementById('editClearBtn');
    const editGenerateBtn = document.getElementById('editGenerateBtn');
    const editModelOptions = document.querySelectorAll('#editTab .model-option');
    const presetBtns = document.querySelectorAll('.preset-btn');

    // State
    let apiKey = localStorage.getItem('gemini_api_key') || '';
    let uploadedImages = [];
    let currentTab = 'create';

    // Initialize
    function init() {
      if (apiKey) {
        showConnectedState();
      }
      updateButtons();
    }

    function showConnectedState() {
      apiSection.classList.add('connected');
      apiStatus.classList.add('active');
      apiStatus.textContent = 'Connected';
      apiInputGroup.style.display = 'none';
      apiConnectedGroup.style.display = 'flex';
    }

    function showDisconnectedState() {
      apiSection.classList.remove('connected');
      apiStatus.classList.remove('active');
      apiStatus.textContent = 'Not connected';
      apiInputGroup.style.display = 'flex';
      apiConnectedGroup.style.display = 'none';
      apiKeyInput.value = '';
    }

    function updateButtons() {
      createGenerateBtn.disabled = !apiKey;
      createEnhanceBtn.disabled = !apiKey;
      createBtn.disabled = !apiKey;
      editGenerateBtn.disabled = !apiKey || uploadedImages.length === 0;
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }

    function hideError() {
      errorMessage.style.display = 'none';
    }

    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        currentTab = tabName;

        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === tabName + 'Tab') {
            content.classList.add('active');
          }
        });

        hideError();
      });
    });

    // API Key Management
    saveApiBtn.addEventListener('click', () => {
      const key = apiKeyInput.value.trim();
      if (key) {
        apiKey = key;
        localStorage.setItem('gemini_api_key', key);
        showConnectedState();
        updateButtons();
      }
    });

    deleteApiBtn.addEventListener('click', () => {
      apiKey = '';
      localStorage.removeItem('gemini_api_key');
      showDisconnectedState();
      updateButtons();
    });

    // Model Selection
    [...createModelOptions, ...editModelOptions].forEach(option => {
      option.addEventListener('click', () => {
        const group = option.closest('.model-selection').querySelectorAll('.model-option');
        group.forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        option.querySelector('input').checked = true;
      });
    });

    // === CREATE TAB ===

    createClearBtn.addEventListener('click', () => {
      createPromptInput.value = '';
      ideaInput.value = '';
      hideError();
    });

    createBtn.addEventListener('click', async () => {
      const idea = ideaInput.value.trim();
      if (!idea) {
        showError('Please enter a quick idea');
        return;
      }

      hideError();
      createBtn.disabled = true;
      createBtn.textContent = 'Creating...';

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            system_instruction: { parts: [{ text: PROMPT_CREATION_SYSTEM }] },
            contents: [{ parts: [{ text: idea }] }]
          })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        const createdPrompt = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (createdPrompt) {
          createPromptInput.value = createdPrompt;
        }
      } catch (error) {
        showError(`Creation failed: ${error.message}`);
      } finally {
        createBtn.disabled = false;
        createBtn.textContent = 'Create Prompt';
      }
    });

    createEnhanceBtn.addEventListener('click', async () => {
      const prompt = createPromptInput.value.trim();
      if (!prompt) {
        showError('Please enter a prompt to enhance');
        return;
      }

      hideError();
      createEnhanceBtn.disabled = true;
      createEnhanceBtn.textContent = 'Enhancing...';

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            system_instruction: { parts: [{ text: PROMPT_ENHANCEMENT_SYSTEM }] },
            contents: [{ parts: [{ text: prompt }] }]
          })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        const enhancedPrompt = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (enhancedPrompt) {
          createPromptInput.value = enhancedPrompt;
        }
      } catch (error) {
        showError(`Enhancement failed: ${error.message}`);
      } finally {
        createEnhanceBtn.disabled = false;
        createEnhanceBtn.textContent = 'Enhance Prompt';
      }
    });

    createGenerateBtn.addEventListener('click', async () => {
      const prompt = createPromptInput.value.trim();
      if (!prompt) {
        showError('Please enter a prompt');
        return;
      }

      await generateImage(prompt, [], 'createModel');
    });

    // === EDIT TAB ===

    function handleImageUpload(files) {
      const fileList = Array.from(files);
      const validTypes = ['image/png', 'image/jpeg', 'image/gif', 'image/webp'];

      if (uploadedImages.length + fileList.length > 14) {
        showError(`Maximum 14 images allowed.`);
        return;
      }

      fileList.forEach(file => {
        if (!validTypes.includes(file.type)) {
          showError(`${file.name}: Invalid format.`);
          return;
        }

        if (file.size > 20 * 1024 * 1024) {
          showError(`${file.name}: File too large (max 20MB)`);
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedImages.push({
            data: e.target.result.split(',')[1],
            mimeType: file.type,
            preview: e.target.result
          });
          updateEditUI();
        };
        reader.readAsDataURL(file);
      });
    }

    function removeImage(index) {
      uploadedImages.splice(index, 1);
      updateEditUI();
    }

    function updateEditUI() {
      const count = uploadedImages.length;

      if (count === 0) {
        uploadPlaceholder.style.display = 'block';
        imagesGrid.style.display = 'none';
        presetsSection.style.display = 'none';
        uploadArea.classList.remove('has-image');
        editGenerateBtn.textContent = 'Apply Edit';
      } else {
        uploadPlaceholder.style.display = 'none';
        imagesGrid.style.display = 'flex';
        presetsSection.style.display = 'block';
        uploadArea.classList.add('has-image');
        editGenerateBtn.textContent = count > 1 ? `Apply Edit (${count} images)` : 'Apply Edit';

        // Show appropriate presets
        if (count === 1) {
          singlePresets.style.display = 'flex';
          multiPresets.style.display = 'none';
        } else {
          singlePresets.style.display = 'none';
          multiPresets.style.display = 'flex';
        }

        renderImagesGrid();
      }
      updateButtons();
    }

    function renderImagesGrid() {
      imagesGrid.innerHTML = '';

      uploadedImages.forEach((img, index) => {
        const item = document.createElement('div');
        item.className = 'image-item';
        item.innerHTML = `
          <img src="${img.preview}" alt="Image ${index + 1}">
          <div class="image-label">Image ${index + 1}</div>
          <button class="remove-image" type="button" data-index="${index}">√ó</button>
        `;
        imagesGrid.appendChild(item);
      });

      if (uploadedImages.length < 14) {
        const addBtn = document.createElement('button');
        addBtn.className = 'add-more-btn';
        addBtn.type = 'button';
        addBtn.innerHTML = '<span>+</span><small>Add</small>';
        addBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          imageInput.click();
        });
        imagesGrid.appendChild(addBtn);
      }

      imagesGrid.querySelectorAll('.remove-image').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          removeImage(parseInt(btn.dataset.index));
        });
      });
    }

    uploadArea.addEventListener('click', (e) => {
      if (!e.target.closest('.remove-image') && !e.target.closest('.add-more-btn')) {
        imageInput.click();
      }
    });

    imageInput.addEventListener('change', (e) => {
      handleImageUpload(e.target.files);
    });

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = '#fde047';
    });

    uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = uploadedImages.length > 0 ? '#22c55e' : '#404040';
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = uploadedImages.length > 0 ? '#22c55e' : '#404040';
      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
      if (files.length > 0) handleImageUpload(files);
    });

    presetBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        editPromptInput.value = btn.dataset.prompt;
      });
    });

    editClearBtn.addEventListener('click', () => {
      uploadedImages = [];
      imageInput.value = '';
      editPromptInput.value = '';
      updateEditUI();
      hideError();
    });

    editGenerateBtn.addEventListener('click', async () => {
      const prompt = editPromptInput.value.trim();
      if (!prompt) {
        showError('Please describe what you want to do with the image(s)');
        return;
      }

      if (uploadedImages.length === 0) {
        showError('Please upload at least one image');
        return;
      }

      await generateImage(prompt, uploadedImages, 'editModel');
    });

    // === SHARED GENERATE FUNCTION ===

    async function generateImage(prompt, images, modelName) {
      hideError();
      outputSection.style.display = 'block';
      outputActions.style.display = 'none';
      generatedImageData = null;
      generatedImageMimeType = null;

      let loadingText = 'Generating image...';
      if (images.length === 1) loadingText = 'Editing image...';
      else if (images.length > 1) loadingText = `Processing ${images.length} images...`;

      outputContent.innerHTML = `<div class="loading"><div class="spinner"></div><span>${loadingText}</span></div>`;

      const btn = currentTab === 'create' ? createGenerateBtn : editGenerateBtn;
      btn.disabled = true;

      const model = document.querySelector(`input[name="${modelName}"]:checked`).value;

      // Retry configuration for transient errors
      const maxRetries = 3;
      const retryableStatuses = [429, 500, 503];

      try {
        const parts = [];

        images.forEach(img => {
          parts.push({
            inline_data: {
              mime_type: img.mimeType,
              data: img.data
            }
          });
        });

        parts.push({ text: prompt });

        let lastError = null;
        let data = null;

        for (let attempt = 0; attempt < maxRetries; attempt++) {
          if (attempt > 0) {
            const waitTime = Math.pow(2, attempt) * 1000; // Exponential backoff: 2s, 4s
            outputContent.innerHTML = `<div class="loading"><div class="spinner"></div><span>Model busy, retrying in ${waitTime/1000}s... (attempt ${attempt + 1}/${maxRetries})</span></div>`;
            await new Promise(resolve => setTimeout(resolve, waitTime));
            outputContent.innerHTML = `<div class="loading"><div class="spinner"></div><span>Retrying... (attempt ${attempt + 1}/${maxRetries})</span></div>`;
          }

          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: parts }],
              generationConfig: {
                responseModalities: ['TEXT', 'IMAGE']
              }
            })
          });

          // Check for retryable HTTP status
          if (retryableStatuses.includes(response.status) && attempt < maxRetries - 1) {
            lastError = new Error(`Server returned ${response.status}. Model is overloaded.`);
            continue;
          }

          data = await response.json();

          // Check for retryable error in response body
          if (data.error) {
            const isOverloaded = data.error.message?.toLowerCase().includes('overloaded') ||
                                 data.error.code === 503 ||
                                 data.error.code === 429;
            if (isOverloaded && attempt < maxRetries - 1) {
              lastError = new Error(data.error.message);
              continue;
            }
            throw new Error(data.error.message);
          }

          // Success - break out of retry loop
          lastError = null;
          break;
        }

        if (lastError) {
          throw lastError;
        }

        const responseParts = data.candidates?.[0]?.content?.parts || [];
        let hasImage = false;
        let textContent = '';

        outputContent.innerHTML = '';

        for (const part of responseParts) {
          if (part.inlineData) {
            hasImage = true;
            generatedImageData = part.inlineData.data;
            generatedImageMimeType = part.inlineData.mimeType;
            const img = document.createElement('img');
            img.src = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
            outputContent.appendChild(img);
          } else if (part.text) {
            textContent += part.text;
          }
        }

        if (hasImage) {
          outputActions.style.display = 'flex';
        }

        if (!hasImage && textContent) {
          outputContent.innerHTML = `<div class="text-response">${textContent}</div>`;
        } else if (!hasImage && !textContent) {
          outputContent.innerHTML = '<div class="output-placeholder">No image generated. Try adjusting your prompt.</div>';
        }

      } catch (error) {
        showError(`Generation failed: ${error.message}`);
        outputContent.innerHTML = '<div class="output-placeholder">Generation failed</div>';
      } finally {
        btn.disabled = false;
      }
    }

    // Download button handler
    downloadBtn.addEventListener('click', () => {
      if (!generatedImageData || !generatedImageMimeType) return;

      // Convert base64 to blob
      const byteCharacters = atob(generatedImageData);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: generatedImageMimeType });

      // Get file extension from mime type
      const ext = generatedImageMimeType.split('/')[1] || 'png';
      const filename = `nano-banana-${Date.now()}.${ext}`;

      // Create download link and trigger
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Initialize
    init();
  </script>
</body>
</html>
